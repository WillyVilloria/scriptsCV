name: pipline-ci-cd
run-name: ${{ github.actor }} Pipeline CI/CD - ${{ github.ref_name }} - ${{ github.event.head_commit.message }}

on: 
  push:
    branches: [ "master", "develop", "feature/*" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "master", "develop", "feature/*" ]

jobs:
  build-test:
    runs-on: ${{ matrix.os }} # le puedo pasar varias OS
    strategy:
      matrix:
        os: [ubuntu-latest] #, macos-latest, windows-latest]
        python-version: ["3.12"] #, "3.10", "3.11", "3.12"]
        exclude:
          - os: macos-latest
            python-version: ["pypy3.10", "3.9", "3.10", "3.11", "3.12", "3.13"]
          - os: windows-latest
            python-version: ["pypy3.10", "3.9", "3.10", "3.11", "3.12", "3.13"]
            
    steps:
      - name: Checkout del cÃ³digo
        uses: actions/checkout@v3

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest flake8

      - name: Linter (flake8)
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics

      - name: Install the code linting and formatting tool Ruff
        run: pipx install ruff

      - name: Lint code with Ruff
        run: ruff check --output-format=github --target-version=py39
        continue-on-error: true
      
      - name: Check code formatting with Ruff
        run: ruff format --diff --target-version=py39
        continue-on-error: true

      - name: Install tox and any other packages
        run: pip install tox
        
      - name: Run tox
      # Run tox using the version of Python in `PATH`
        run: tox -e py

      - name: Ejecutar tests
        run: pytest -v tests

  deploy:
      needs: build-test
      runs-on: ubuntu-latest
      if: >
        startsWith(github.ref, 'refs/tags/v') ||
        github.ref == 'refs/heads/master' ||
        github.ref == 'refs/heads/develop' ||
        startsWith(github.ref, 'refs/heads/feature/')
      
      environment: dev   # ğŸ‘ˆ aquÃ­ pones el entorno con aprobaciÃ³n manual
      

      steps:
      - name: Checkout del cÃ³digo
        uses: actions/checkout@v3

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"
